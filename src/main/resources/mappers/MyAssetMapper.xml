<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.myasset.myasset.mapper.MyAssetMapper">
    <select id="selectTrList" parameterType="com.myasset.myasset.vo.MyAssetVo" resultType="com.myasset.myasset.vo.MyAssetVo">
        SELECT 
            ASSET_NM assetNm,
            ASSET_CATG_NM assetCatgNm,
            TR_METHOD trMethod,
            TR_AMT trAmt,
            TR_PRICE trPrice,
            TR_TOTPRICE trTotprice,
            TR_COST trCost,
            TR_RESULT trResult,
            TR_EARNRATE trEarnrate,
            TR_DATE trDate
        FROM TRADE_RECORD
        WHERE 1 = 1
        <if test="assetNm != null and assetNm != ''">
        AND ASSET_NM = #{assetNm}
        </if>
        <if test="trMethod != null and trMethod != ''">
        AND TR_METHOD = #{trMethod}
        </if>
        <choose>
            <when test="sortType == 'asc'">
                <if test="sortNm == 'date'">
                ORDER BY TR_DATE
                </if>
                <if test="sortNm == 'assetNm'">
                ORDER BY ASSET_NM
                </if>
            </when>
            <otherwise>
                <if test="sortNm == 'date'">
                ORDER BY TR_DATE desc
                </if>
                <if test="sortNm == 'assetNm'">
                ORDER BY ASSET_NM desc
                </if>
            </otherwise>
        </choose>
        
        <if test="recordCountPerPage != null and recordCountPerPage != ''">
        LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
        </if>
    </select>

    <select id="selectTrListCnt" parameterType="com.myasset.myasset.vo.MyAssetVo" resultType="String">
        SELECT COUNT(*)
        FROM TRADE_RECORD
        WHERE 1 = 1
        <if test="assetNm != null and assetNm != ''">
        AND ASSET_NM = #{assetNm}
        </if>
        <if test="trMethod != null and trMethod != ''">
        AND TR_METHOD = #{trMethod}
        </if>
        ORDER BY TR_DATE
    </select>

    <select id="selectMyAssetInfo" parameterType="com.myasset.myasset.vo.MyAssetVo" resultType="com.myasset.myasset.vo.MyAssetVo">
        SELECT *
        FROM MYASSETS
    </select>

    <select id="selectAssetCatgList" parameterType="com.myasset.myasset.vo.MyAssetVo" resultType="com.myasset.myasset.vo.MyAssetVo">
        SELECT 
        asset_catg_nm assetCatgNm
        ,asset_catg_cd assetCatgCd
        FROM ASSET_CATG
    </select>

    <insert id="insertTrRecord" parameterType="com.myasset.myasset.vo.MyAssetVo">
        INSERT INTO `myasset`.`trade_record` (`asset_nm`, `asset_catg_nm`, `tr_method`, `tr_amt`, `tr_price`, `tr_totprice`, `tr_cost`
        <if test="trMethod == '매도'">
        ,`tr_result`, `tr_earnrate`
        </if>
        , `tr_date`) 
        VALUES (#{assetNm}, #{assetCatgNm}, #{trMethod}, #{trAmt}, #{trPrice}, #{trTotprice}, #{trCost}
        <if test="trMethod == '매도'">
        , #{trResult}, #{trEarnrate}
        </if>
        , #{trDate});
    </insert>
    
    <update id="updateMyAsset" parameterType="com.myasset.myasset.vo.MyAssetVo">
    INSERT INTO `myasset`.`myassets` (
         `asset_nm`
         <if test="assetCatgNm != null and assetCatgNm != ''">
         ,`asset_catg_nm` 
         </if>
         <if test="assetAmt != null and assetAmt != ''">
         ,`asset_amt` 
         </if>
         <if test="assetPrice != null and assetPrice != ''">
         ,`asset_price`
         </if>
         <if test="assetTotprice != null and assetTotprice != ''">
         ,`asset_totprice`
         </if>
         <if test="assetNowTotal != null and assetNowTotal != ''">
         ,`asset_now_total`
         </if>
         <if test="assetNowAvg != null and assetNowAvg != ''">
         ,`asset_now_avg`
         </if>
    ) VALUES (
        #{assetNm}
        <if test="assetCatgNm != null and assetCatgNm != ''">
        ,#{assetCatgNm}
        </if>
        <if test="assetAmt != null and assetAmt != ''">
        ,#{assetAmt}
        </if>
        <if test="assetPrice != null and assetPrice != ''">
        ,#{assetPrice}
        </if>
        <if test="assetTotprice != null and assetTotprice != ''">
        ,#{assetTotprice}
        </if>
        <if test="assetNowTotal != null and assetNowTotal != ''">
        ,#{assetNowTotal}
        </if>
        <if test="assetNowAvg != null and assetNowAvg != ''">
        ,#{assetNowAvg}
        </if>
        
    ) 
    ON DUPLICATE KEY UPDATE
    `asset_nm` = #{assetNm}
    <if test="assetAmt != null and assetAmt != ''">
    ,`asset_amt` = #{assetAmt}  
    </if>
    <if test="assetPrice != null and assetPrice != ''">
    ,`asset_price` = #{assetPrice}
    </if>
    <if test="assetTotprice != null and assetTotprice != ''">
    ,`asset_totprice` = #{assetTotprice}
    </if>
    <if test="assetNowTotal != null and assetNowTotal != ''">
    ,`asset_now_total` = #{assetNowTotal}
    </if>
    <if test="assetNowAvg != null and assetNowAvg != ''">
    ,`asset_now_avg` = #{assetNowAvg}
    </if>
    </update>

    <update id="deleteAsset" parameterType="com.myasset.myasset.vo.MyAssetVo">
        UPDATE `myasset`.`myassets`
        SET `ers_yn` = #{ersYn}
        WHERE `asset_nm` = #{assetNm}
    </update>

    <select id="selectNowTotal" parameterType="com.myasset.myasset.vo.MyAssetVo" resultType="String">
    SELECT (
        (
        SELECT SUM(tr_totprice) - SUM(tr_cost) 
        buyTot
        FROM trade_record
        WHERE asset_nm = #{assetNm} AND tr_method = '매수'
        ORDER BY tr_date ASC
        )
        -
        (
        SELECT SUM(tr_totprice) - SUM(tr_cost) 
        sellTot
        FROM trade_record
        WHERE asset_nm = #{assetNm} AND tr_method = '매도'
        ORDER BY tr_date ASC)
        +
        (SELECT SUM(tr_result) TotR
        FROM trade_record
        WHERE asset_nm = #{assetNm} AND tr_method = '매도'
        ORDER BY tr_date ASC)
        )totP
        FROM DUAL
    </select>
</mapper> 